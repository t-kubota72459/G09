# マイコン実習 (第４クォータ編)
---

# 🏭 MicroPython FA制御＆技能照査「基礎から合格、そして実践へ」統合カリキュラム

### 概要

本カリキュラムは、**ESP32 (MicroPython)** を用い、前半で **技能照査（実技試験）** の合格に必要な電子回路とプログラミングの基礎を固め、後半でその技術を **24V FA機器（ピックアンドプレース）** の制御へと応用する、実践的なエンジニアリングコースである。

* **対象:** 工科系大学2年生（後期）
* **時間:** 200分 × 9回
* **前提:** ESP32/RasPiの経験あり、C言語未履修（MicroPythonを使用）

---

## 🏁 序章：エンジニアリングの楽しさを再確認

### 第1回：ライントレーサー・リベンジ（完結編）
* **目標:** 前期からの課題であるライントレーサーを完走させ、「入力(センサ)→判断(マイコン)→出力(モータ)」のフィードバック制御を再確認する。
* **内容:**
    1.  **ハードウェア最終調整 (80分):** センサ位置の修正、配線トラブルの解決。
    2.  **制御ロジック実装 (80分):** シンプルなオンオフ制御、またはP制御を実装。
    3.  **タイムトライアル (40分):** コースを1周完走させ、プロジェクトに区切りをつける。

    「センサの値を読んで、モータの出力を決める」というループ処理が、来週から学ぶ「シーケンス制御」の基本構造と同じである。

---

## ⚡ 第1部：技能照査「素地固め」フェーズ（基礎電子回路）

**技能照査およびFA制御で必須となる「回路知識」と「コードの書き方」を徹底的に学ぶ。**

### 第2回：入力と出力の基礎（プルアップとトランジスタ）

* **目標:** **「スイッチ入力の不定状態」**　と　**「トランジスタによる増幅」**　を理解し、回路図を読めるようにする。
 
* **講義:**
    * **プルアップ/プルダウン抵抗:** スイッチOFF時の「電圧浮き（不定）」の危険性と対策。
    * **トランジスタ駆動 (PNP/NPN):** マイコン直結駆動の危険性。技能照査用 **PNP (2SA1015)** と FA用 **NPN (2SC1815)** の違い。
    
* **実習:**
    * **実験A (入力):** プルアップ抵抗の有無による入力値の安定性を確認。
    * **実験B (出力):** PNPトランジスタを使ってLEDを点灯させる回路を組む（技能照査回路の一部）。
    * **⚠️ ESP32特記:** 技能照査回路図の「5Vライン」を **「3.3V」** に読み替えて配線することを徹底（PNPのOFF不良防止）。

### 第3回：7セグメントLEDと「配列」処理
* **目標:** 7セグ（アノードコモン）の点灯制御と、試験時間を短縮する効率的なコーディング。
* **講義:**
    * **アノードコモン:** Vcc共通、LOWで点灯する仕組み。
    * **ビットマップ:** `0`を表示するには `0x3F` (0b00111111) を送る、という理屈。
     
* **実習:**
    * **配線:** 第2回のTR回路を応用し、7セグLEDを配線する。
    * **配列（リスト）化:** `if num == 1:` の羅列は禁止。`digits = [0x3F, 0x06, ...]` という配列を作成し、`output(digits[num])` で表示するテクニックを習得。

### 第4回：タイマー割込みとステートマシン
* **目標:** 「時間管理」と「状態遷移」をマスターし、FA制御の頭脳を作る。
* **講義:**
    * **ノンブロッキング処理:** `time.sleep()` を使うとスイッチ入力を取りこぼす理由。
    * **ステートマシン:** システムを「停止中」「計測中」「設定中」などの「状態(State)」で管理する手法。
* **実習:**
    * **タイマー:** `machine.Timer` を使い、メインループを止めずに正確に1秒を刻む。
    * **ストップウォッチ作成:** スタート/ストップボタンで状態を遷移させ、時間をカウントアップするプログラムを完成させる。

---

## 🛡️ 第2部：技能照査「実戦対策」フェーズ（模擬試験）

### 第5回：模擬試験①（標準課題・配線力強化）
* **目標:** 制限時間内に、仕様書通りの回路を「美しく」「正確に」配線する。
* **内容:**
    * **課題:** 令和5年度の技能照査課題（カウンタ回路）を使用。
    * **実技:** 第2〜3回で学んだ知識を総動員し、何も見ずに回路を組み上げ、基本プログラム（カウントアップ）を動作させる。
    * **チェック:** 電源投入前にテスターでVcc-GND間のショートがないか確認する「指差呼称」を義務付ける。

### 第6回：模擬試験②（仕様変更・対応力強化）
* **目標:** 試験中の「仕様変更」にパニックにならず対応する。
* **内容:**
    * **タイムトライアル:** 本番形式でスタート（回路作成〜プログラミング）。
    * **仕様変更:** 開始90分後に教員から**追加仕様**を通達。
        * 例：「カウントダウンに変更せよ」
        * 例：「偶数の時だけドット(dp)を点灯せよ」
    * **ポイント:** 第3回の「配列」や第4回の「ステートマシン」構造を使っていれば、数行の修正で対応できることを体感させる。

---

## 🏭 第3部：FA制御「ピックアンドプレース」実践フェーズ

**3.3Vの世界（技能照査）から、24Vの世界（工場設備）へ技術を昇華させる。**

### 第7回：3.3Vから24Vへ！ オープンコレクタとリレー
* **目標:** 第2回で学んだ「トランジスタ駆動」を応用し、24Vの強電機器を動かす。
* **講義:**
    * **オープンコレクタ:** NPNトランジスタ(2SC1815)を使ったシンク回路。
    * **リレー駆動:** コイルの逆起電力とフライホイールダイオードの役割。
* **実習:**
    * **回路製作:** ESP32で **OMRON MY4リレー** を駆動する回路を構築。
    * **If_CQ基板:** フォトカプラ入力に24Vセンサを、リレー出力にソレノイドバルブを接続し、動作確認。

### 第8回：ピックアンドプレース シーケンス制御
* **目標:** エアシリンダとハンドを連携させ、物品搬送を実現する。
* **実習:**
    * **単動関数化:** `grip()`, `lift_up()`, `move_right()` などの基本動作関数を作成。
    * **自動運転:** 第4回で学んだ**ステートマシン**を活用し、「原点復帰 → 下降 → 吸着 → 上昇 → 移動」のシーケンスを実装。
    * **インターロック:** 「ワークがないとスタートしない」等の安全条件を追加。

### 第9回：FAシステム総合演習（集大成）
* **目標:** 独自の仕様（レシピ）に基づき、ピックアンドプレース装置を自在に操る。
* **課題:**
    * 「3回搬送したら終了」「異常時は赤ランプ点滅」など、技能照査課題の要素をFA装置に盛り込む。
* **総括:**
    * 技能照査で学んだ基礎（プルアップ、トランジスタ、配列、ステートマシン）が、実際の工場の装置（24V FAシステム）の中にどう生きているかを振り返る。

---

### 💡 指導用メモ（ESP32で技能照査を行う際の補足）

1.  **ピン変換表:**
    Arduinoの `D2`, `D3`... を、ESP32 DevKitCの `IO16`, `IO17`... に割り当てる対応表を配布してください。
2.  **3.3V電源:**
    技能照査の回路図にある「5V」は全て「3.3V」として扱わせてください。特にPNPトランジスタのエミッタを5Vに繋ぐと制御不能になります。
3.  **抵抗値:**
    支給品の抵抗（LED用220Ωなど）は3.3V環境でもそのまま使用可能です（輝度は下がりますが実用範囲内です）。