# Raspberry Pi 公式カメラをいじる

今回は新しいデバイスとして Raspberry Pi 公式カメラ V3 を操作してみよう。

## 注意!!

現在、Raspberry Pi の公式カメラとして、V2 と V3 のふたつが販売されている。どちらを使うかで Python のプログラムや Raspberry Pi の設定内容が変わってくる (互換性がない) ので、インターネットなどを参考にするときは、どちらのカメラを利用している記事であるか、十分、注意すること。

今後は、V3 を利用した記事が増えていくと思う。

繰り返し：**今回扱うのは V3 である。**

# カメラをつなげる

Raspberry Pi 公式カメラは 4 種類のモデルがある。

1. 標準モデル
2. 広角モデル
3. 赤外線フィルタなしモデル
4. 広角＋赤外線フィルタなしモデル

通常は標準モデルでよいと思うが、暗視カメラにしたい、広角の画角が必要といったときには 2,3,4 のモデルを検討する。
また V3 カメラからオートフォーカスになった。V2 はマニュアルフォーカスなのでここでも違いがある。

## カメラの取り付け

V3 カメラは HDMI 出力の隣になる CAMERA インターフェースに取り付ける。

0. Raspberry Pi をシャットダウンする。
1. 白いプラスチックのガードを**優しく** 持ち上げる。力づくでやると割れる。
2. カメラのフレキシブルケーブル (フレキケーブル) の金の端子が出ている側を HDMI 側に向けて、差し込む。
3. そのあと **優しく** 白いプラスチックのガードを押し下げる。無理やり差し込むと割れる。
4. Raspberry Pi を立ち上げる。

■ お約束：例年、白いプラスチックのガードを破壊するものが現れる。

<div style="text-align: center;">
    <img src="https://sozorablog.com/wp-content/uploads/2021/12/camera-connect-768x432.jpg"width="60%"><br/>
</div>

<div style="text-align: center;">
    <img src="https://sozorablog.com/wp-content/uploads/2021/12/raspberry-pi-camera-v2-2-2-768x928.jpg"width="60%"><br/>
</div>

<div style="text-align: center;">
    <img src="https://sozorablog.com/wp-content/uploads/2021/12/raspberry-pi-camera-v2-1-2-659x1024.jpg" width="60%"><br/>
</div>



## 正しく取り付けられているか確認

以下のように `libcamera-still` コマンドを実行してカメラの映像が現れたら OK.

libcamera-still コマンドは JPG ファイルを取得するコマンドである。

-t オプションは、シャッターを切るまでのタイムアウト時間を指定する。`-t 0` でタイムアウトしないでずっとプレビュー画面が表示される。(ネットワーク経由で実行するとめちゃめちゃ重い！)

画面の表示から、2304x1296 画素の映像であることがわかる。

```sh
$ libcamera-still -t 0
takaya@kubota-pi2:~ $ libcamera-still -t 0
Made X/EGL preview window
[22:14:54.011321551] [16029]  INFO Camera camera_manager.cpp:297 libcamera v0.0.5+83-bde9b04f
[22:14:54.337512614] [16031]  INFO RPI vc4.cpp:437 Registered camera /base/soc/i2c0mux/i2c@1/imx708@1a to Unicam device /dev/media2 and ISP device /dev/media0
[22:14:54.337731884] [16031]  INFO RPI pipeline_base.cpp:1101 Using configuration file '/usr/share/libcamera/pipeline/rpi/vc4/rpi_apps.yaml'
[22:14:54.345801014] [16029]  INFO Camera camera.cpp:1033 configuring streams: (0) 2048x1152-YUV420
[22:14:54.347486318] [16031]  INFO RPI vc4.cpp:565 Sensor: /base/soc/i2c0mux/i2c@1/imx708@1a - Selected sensor format: 2304x1296-SBGGR10_1X10 - Selected unicam format: 2304x1296-pBAA
```

`-t 0` を省略すると５秒後に自動的に終了する。
`-o fileame` で、そのファイル名で画像を保存する。

```sh
$ libcamera-still -o image.jpg
```

## libcamera コマンド

Raspberry Pi のカメラを扱うコマンドの集まりは `libcamera-xxxx` という形になっている (V3 以降。V2 までは違うコマンド)。ここでは代表的な `libcamera-xxxx` コマンドと、それぞれの用途について簡単に解説する。

**1. カメラプレビューを表示:**

* **libcamera-hello:** カメラプレビューを5秒間表示します。基本的な動作確認に使用できます。
* **libcamera-raspicam:** 従来の `raspicam` コマンドと同様の機能を提供します。静止画撮影、動画撮影、プレビュー表示などが可能です。
* **libcamera-raw:** カメラモジュールからRAWデータを直接キャプチャします。高度な画像処理などに活用できます。

**2. 静止画撮影:**

* **libcamera-still:** 静止画を撮影します。解像度、ホワイトバランス、露出補正などのオプションを設定できます。
* **libcamera-jpeg:** 静止画をJPEG形式で保存します。圧縮率や品質などのオプションを設定できます。
* **libcamera-png:** 静止画をPNG形式で保存します。圧縮方式やカラー深度などのオプションを設定できます。

**3. 動画撮影:**

* **libcamera-vid:** 動画を撮影します。解像度、フレームレート、エンコーディング形式などのオプションを設定できます。
* **libcamera-h264:** 動画をH.264形式で保存します。ビットレートやGOPサイズなどのオプションを設定できます。
* **libcamera-rawvid:** 動画をRAWデータ形式で保存します。編集や分析などに活用できます。

**4. カメラ設定の変更:**

* **libcamera-info:** カメラモジュールの情報 (解像度、フレームレート、センサー情報など) を表示します。
* **libcamera-controls:** カメラの設定項目と現在の値を一覧表示します。
* **libcamera-set-control:** 特定の設定項目の値を変更します。ホワイトバランス、露出補正、シャッタースピードなどを調整できます。

**5. その他:**

* **libcamera-clip:** カメラモジュールから切り抜いた領域をキャプチャします。
* **libcamera-osc:** カメラモジュールをOSCプロトコルで制御します。
* **libcamera-docs:** libcameraライブラリのドキュメントを表示します。

**補足:**

* 上記以外にも、様々なコマンドが用意されています。詳細は公式ドキュメントを参照してください。
* コマンドを実行するには、ターミナルで `libcamera-xxxxx` のように入力します。
* オプションを使用するには、コマンド名の後に `--option=値` の形式で指定します。
* 詳細なオプション情報については、各コマンドのヘルプドキュメントを参照してください。

**参考資料:**

* **libcamera 公式ドキュメント:** [https://github.com/topics/libcamera](https://github.com/topics/libcamera)
* **Raspberry Pi 公式ドキュメント:** [https://www.raspberrypi.com/documentation/accessories/camera.html](https://www.raspberrypi.com/documentation/accessories/camera.html)


# カメラ操作練習

- libcamera-still で jpg 画像を撮影し、それを scp コマンドを使って Windows 側に転送し、表示させてください。
- libcamera-vid で動画を撮影し、それを scp コマンドを使って Windows 側に転送し、表示させてください。  
■ ヒント  
    1. libcamera-vid で取得したファイルの拡張子は .h264 とする。 
    2. Windows の標準の Media Player では再生できない。VLCメディアプレーヤーをインストールする。


# Raspberry Pi カメラを Python で使う

さて、これまで紹介した方法は Linux であらかじめ用意されたコマンドを使ってカメラを操作する方法だった。
このままでは、画像認識 (画面になにが写っているか認識する。車載カメラの歩行者検知やカメラの瞳 AF などのようなこと) はできない。
そのようなすこしインテリジェントなことをするには、Python からカメラを操作できるようにする必要がある。

## 環境の更新

まずは最新の環境に更新：

```sh
$ sudo apt upgade
$ sudo apt upgrade -y
$ sudo reboot           # 更新を反映
```

## ライブラリのインストール

`pip` コマンド (Python のモジュールを管理するコマンド) を最新に更新：

```sh
$ sudo python -m pip install --upgrade pip
```

つづいて、最新になった `pip` コマンドを使って OpenCV をインストール：

```sh
$ sudo pip install opencv-python
```

numpy というライブラリを最新に：

```sh
$ sudo pip install -U numpy
```

picamera2 ライブラリをインストール。picamera2 が python からカメラを操作するための核となる：

```sh
$ sudo apt install python3-picamera2
```

`libatlas3-base` というパッケージをインストール：

```sh
$ sudo apt install libatlas3-base
```

以上が正常に終了すれば、OpenCV と picamera2 モジュールを使って Python からカメラを使った画像処理ができるようになる。

# Python プログラムで撮影する

## 静止画の撮影

1. Thonny を立ち上げる
2. 以下のプログラムをコピペする  
    ```python
    from picamera2 import Picamera2
    picam2 = Picamera2()       # カメラを有効にする

    #カメラ画像を保存する
    picam2.start_and_capture_file("test.jpg")
    ```
3. プログラムを保存して実行 (RUN)  
test.jpg というファイル名で画像が保存される。

## 動画の撮影

以下のプログラムをコピペ、実行する

```python
from picamera2 import Picamera2

picam2 = Picamera2()

# 5秒間の動画を撮影して保存する
picam2.start_and_record_video("test.mp4", duration=5)
```

５秒の動画が保存される。

## Python からカメラ映像を動的に表示する

picamera2 ライブラリと OpenCV ライブラリを組み合わせて、カメラから取得した映像を動的に表示させてみる。
オートフォーカスを有効にしているので、被写体の距離が変化しても鮮明に撮影できる。

```python
import cv2
from picamera2 import Picamera2
from libcamera import controls

picam2 = Picamera2()
picam2.configure(picam2.create_preview_configuration(main={"format": 'XRGB8888', "size": (640, 480)}))
picam2.start()
#カメラを連続オートフォーカスモードにする
picam2.set_controls({"AfMode": controls.AfModeEnum.Continuous})

while True:
  im = picam2.capture_array()
  cv2.imshow("Camera", im)
 
  key = cv2.waitKey(1)
  # Escキーを入力されたら画面を閉じる
  if key == 27:
    break

picam2.stop()
cv2.destroyAllWindows()
```