# データの永続化 (CSVファイルの基礎)

これまでのプログラムでは、バーコードから読み取ったデータはメモリ上に一時的に保持されるだけで、プログラムを終了すると失われる。これでは管理システムとしての要件を満たせない。

そこで、読み取った「バーコード番号」と「時刻」を、いつでも参照可能な状態にするため**ファイル**として永続化する。本稿では、そのデータ交換形式として**CSVファイル**を用いる。

## CSVファイルとは

CSVは「**C**omma-**S**eparated **V**alues」の略称であり、日本語では「**カンマで区切られた値**」と訳される。その名の通り、データをカンマ「`,`」を区切り文字として羅列した、プレーンテキスト形式のファイルフォーマットである。

例えば、出退勤ログを CSV 形式で表現すると以下のようになる。

**`attendance.csv` の内容**

```
日付,時刻,バーコード番号
2025-08-29,10:55:12,20250001
2025-08-29,10:56:01,20250002
2025-08-29,17:30:45,20250001
```

  * **1行** が **1つのレコード**（一件の記録）に相当する。
  * 各行のフィールド（日付、時刻、番号など）は **カンマ** によって分割される。
  * この形式のファイルは、Microsoft Excelなどの多くの表計算ソフトウェアで直接開くことが可能である。その際、カンマはセルの区切りとして解釈され、データは表形式で表示される。

特定のアプリケーションに依存しないテキストベースのフォーマットであるため、可読性が高く、異なるシステム間でのデータ交換に広く利用されている。

-----

## PythonによるCSVファイルの基本操作 📂

Pythonでファイルを扱うには、`open()`関数を用いてファイルを特定のモードで「開き」、処理完了後に`close()`メソッドで「閉じる」のが基本である。リソースリークを防ぐため、ファイルのクローズ処理を自動化する`with`構文の利用が強く推奨される。

### 1. 新規ファイルへの書き込み (`'w'` モード)

`open()`関数の第2引数に `'w'` (write) を指定すると、ファイルは書き込みモードで開かれる。このモードでは、**指定したファイルが既に存在する場合、その内容は全て破棄され、新しい内容で上書きされる**点に注意を要する。

**サンプルコード**

```python
# -*- coding: utf-8 -*-

# 保存するデータ
header = "日付,時刻,バーコード番号\n"  # \n は改行コード
record1 = "2025-08-29,11:05:20,20250001\n"
record2 = "2025-08-29,11:05:55,20250002\n"

# 'w'モードでファイルを開く。存在しない場合は新規作成される。
with open('attendance.csv', 'w', encoding='utf-8') as f:
    # f.write()で文字列データをファイルに書き込む
    f.write(header)
    f.write(record1)
    f.write(record2)

print("ファイル 'attendance.csv' を作成した。")
```

`encoding='utf-8'`の指定は、日本語を含むマルチバイト文字が正しく扱われることを保証するために重要である。

### 2. ファイルの読み込み (`'r'` モード)

`'r'` (read) を指定すると、ファイルは読み込みモードで開かれる。

**サンプルコード**

```python
# -*- coding: utf-8 -*-

try:
    with open('attendance.csv', 'r', encoding='utf-8') as f:
        # .readlines() はファイルの内容を1行ずつの文字列からなるリストとして返す
        lines = f.readlines()
        
    for line in lines:
        # .strip()で前後の空白文字や改行コードを除去して表示
        print(line.strip())

except FileNotFoundError:
    print("エラー: ファイル 'attendance.csv' が見つからない。")
```

一行ずつデータを反復処理する場合、`readlines()`は有用なメソッドである。

-----

## 出欠席システムへの実装

これらの知識を基に、バーコードリーダーから得たデータをCSVファイルへ追記する機能を実装する。

既存のログを消さずにデータを末尾に追加するためには、`'w'`モードではなく **`'a'` (append) モード** を使用する必要がある。`'a'`モードは、ファイルが存在すればその末尾から書き込みを開始し、ファイルが存在しなければ新規に作成する。

`'a'`モードを用いて、バーコードから読み取ったID、読み取り時刻を CSV ファイルにしよう。
