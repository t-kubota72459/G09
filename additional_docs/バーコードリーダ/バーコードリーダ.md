# バーコードリーダを使ってみよう

-----

## 🚀 マイコン実習課題：バーコードリーダーを用いた出退勤・登下校管理システムの構築

コンビニエンスストアのPOSシステムや図書館の蔵書管理で利用されるバーコード読み取りは、身近な情報入力技術である。本実習では、この仕組みを自ら構築する。シングルボードコンピュータであるRaspberry Piとバーコードリーダーを組み合わせ、研究室の入退室や学籍情報の管理に応用可能な、出退勤・登下校管理システムを開発する。

### 🎯 課題の目標 (到達目標)

本システムの完成により、特定のIDを持つ人物が、いつ、どのタイミングで記録されたかを自動で管理するシステムの構築が可能となる。この開発経験を通して、以下の技術的スキルを習得する。

  * **ハードウェア・ソフトウェアの統合**: Raspberry Piに接続された周辺機器（バーコードリーダー）を、Pythonプログラムによって制御する技術。
  * **データハンドリング**: バーコードから得られる文字列情報を、日時情報（タイムスタンプ）と関連付け、CSV形式等の構造化データとして永続化する能力。
  * **実践的な問題解決能力**: 「入力信号の欠落」や「時刻同期の不整合」といった、物理的なシステム開発において発生しうる諸問題に対し、論理的な思考に基づき自ら解決策を導き出す能力。
  * **IoTの基礎概念理解**: 物理世界の情報（バーコード）をデジタルデータとして取得し、コンピュータネットワークを介して活用する、IoT (Internet of Things) の基本構成要素を実践的に理解する。

-----

### 🛠️ 必要機材リスト

  * **制御中枢**: Raspberry Pi 本体
  * **入力装置**: USB 接続型バーコードリーダー
  * **ユーザインターフェース**: モニター、キーボード、マウス
  * **記憶媒体**: OSインストール用のmicroSDカード
  * **電源**: Raspberry Pi用ACアダプター
  * **被識別媒体**: バーコードが付与されたカード（学生証等）。存在しない場合は、[Webサイト](https://www.google.com/search?q=https://www.japan-systems.co.jp/solution/jd-barcode/barcode-font/test/)等を利用し、ユニークなバーコードを生成・印刷して使用すること。

-----

### 🗺️ システム開発の工程 (ロードマップ)

本課題は、以下のステップに分割される。各工程を順次、確実に完了させること。

#### STEP 1: Raspberry Pi の基本設定 (セットアップ)

まず、Raspberry Piを動作可能な状態にする。指定されたOSイメージをmicroSDカードに書き込み、起動後の初期設定（ネットワーク、言語設定等）を完了させる。これは、以降の開発における基礎環境の構築工程である。

#### STEP 2: バーコードリーダーの接続と動作検証 (入力確認)

USBポートにバーコードリーダーを接続する。接続するたびにデバイスファイルができることを確認する。

#### STEP 3: Pythonによるシリアル通信でのデータ取得 (プログラミング)

バーコードリーダーからの入力をプログラムで受け取る。リーダーの動作モードには、キーボードのように振る舞うHIDモードと、直接データを送信するシリアルモードがある。HIDモードは手軽だが、他の入力と混線する可能性があるため、本実習ではより確実性の高い**シリアル通信**によるデータ取得方法を採用する。

##### 1\. ライブラリの導入

まず、Pythonでシリアル通信を扱うための標準的なライブラリ`pyserial`を導入する。ターミナルで以下のコマンドを実行すること。

```bash
pip install pyserial
```

##### 2\. デバイスのポートを確認

Raspberry Piにバーコードリーダーを接続すると、 `/dev/ttyUSB0` や `/dev/ttyACM0` といったデバイスファイルとして認識される。この「ポート」が、プログラムとリーダーが対話するための窓口となる。
どのポートに接続されたか不明な場合は、リーダーを接続した状態で以下のコマンドを実行し、表示されるリストからそれらしい名前を探すこと。

```bash
ls /dev/tty*
```

##### 3\. データ取得プログラムの作成

次に、指定したシリアルポートを監視し、データが送信されてきたら読み取るプログラムを作成する。バーコードをスキャンすると、リーダーからデータが一行の文字列として送信されてくる。これを受信し、プログラムで扱えるように変換（デコード）する。

以下のコードは、その基本的な構造である。

```python
import serial
import time

# --- 設定値 ---
# ポート名は環境に合わせて変更すること (例: '/dev/ttyACM0')
PORT = '/dev/ttyUSB0' 
# ボーレート(通信速度)は機器のマニュアルで確認する。9600が一般的。
BAUDRATE = 9600
TIMEOUT = 1 # タイムアウト時間 (秒)

# シリアルポートの初期化
# 'with'構文を使うと、プログラム終了時に自動でポートを閉じてくれる
try:
    with serial.Serial(PORT, BAUDRATE, timeout=TIMEOUT) as ser:
        print(f"シリアルポート {PORT} を監視中...")
        
        # 無限ループで常にデータを待ち受ける
        while True:
            # シリアルポートから1行読み取る
            # データはバイト列で来るため、'utf-8'で文字列にデコードする
            # .strip()で前後の余白や改行コードを削除する
            line = ser.readline().decode('utf-8').strip()
            
            # データがあれば表示する
            if line:
                print(f"受信データ: {line}")
            
            # CPU使用率が高くなりすぎないように少し待機
            time.sleep(0.1)

except serial.SerialException as e:
    print(f"エラー: シリアルポート {PORT} を開けません。")
    print(e)
except KeyboardInterrupt:
    print("プログラムを終了します。")

```

このプログラムを実行し、バーコードをスキャンした際に、ターミナルにバーコードのデータが表示されれば、このステップは成功である。

#### STEP 4: タイムスタンプの付与 (時刻情報)

識別情報（バーコード）のみでは、管理ログとして不完全である。Pythonの標準ライブラリである`datetime`モジュールを利用し、データ入力が検知された時点の正確な日時情報を取得する。取得した日時情報は、バーコード情報と必ず対で扱う必要がある。

#### STEP 5: データの永続化 (ログファイル生成)

取得した「バーコード情報」と「タイムスタンプ」のペアを、再利用可能な形式でファイルシステム上に保存する。データ形式としては、可読性が高く、多くの表計算ソフトウェアで扱えるCSV (Comma-Separated Values) 形式を推奨する。

**ログファイルフォーマット例 ( `attendance.log` )**

```csv
timestamp,barcode_id
2025-08-22T10:35:12,20250001
2025-08-22T10:36:01,20250002
```

-----

### ✨ 発展課題

基本システムを完成させた後、各自の裁量で以下の機能拡張に取り組むことを推奨する。

  * **GUIによるフィードバック**: データをスキャンした際、CUIへの出力だけでなく、GUIウィンドウに「認証成功：〇〇」といったメッセージや画像を表示する。
  * **入退室状態の管理**: 同一IDがスキャンされた回数のパリティ（奇数/偶数）を基に、「入室」と「退室」の状態を判定し、ログに記録するロジックを実装せよ。
  * **Webサーバー機能の実装**: 記録されたログデータを、HTTP経由で他のコンピュータのWebブラウザから閲覧可能にするWebアプリケーションを構築する。
  * **外部サービス連携**: 特定のIDがスキャンされたことをトリガーに、LINE NotifyやSlack等の外部APIへ通知を送信する機能を実装する。

-----
